<html>
<head>
<title>Deliver Your Java Application in One-JAR!</title>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<table align="center" cellpadding="20">
	<tr>
		<td><a
			href="http://prdownloads.sourceforge.net/one-jar/one-jar-example-0.95.jar?download">
		<img src="download-examples.jpg" border="0"
			alt="download one-jar examples" /></a></td>
		<td><a href="http://www.sourceforge.net/projects/one-jar"
			target="_blank"> <img src="one-jar.jpg" border="0"
			alt="one-jar at sourceforge.net" /> </a></td>
		<td><a href="http://www.simontuffs.com" target="_blank"> <img
			src="simontuffs.com.jpg" border="0" alt="simontuffs.com" /> </a></td>
		<td><a href="one-jar-license.txt" target="_blank"> <img
			src="license.jpg" border="0" alt="licensing information" /> </a></td>
		<td><a href="http://sourceforge.net" target="_blank"> <img
			src="http://sourceforge.net/sflogo.php?group_id=111153&amp;type=2"
			width="125" height="37" border="0" alt="SourceForge.net Logo" /> </a></td>
		<!--
<td>
  <a href="http://sourceforge.net/sendmessage.php?touser=82967" target="_blank">
    <img src="contact.jpg" border="0" alt="Contact Me" />
  </a>
</td>
-->
	</tr>
</table>
<hr>
<h1>Deliver Your Java Application in One-JAR!</h1>
<b>by P. Simon Tuffs, Software Architect and Consultant (<a
	href="http://www.simontuffs.com">www.simontuffs.com</a>)</b>
<p></p>
<hr>
<p></p>
<h2>Introduction</h2>
Java developers often come to a point where they wish to deliver their application 
as a single Jar file.  The Java Runtime Environment supports running a Jar file using the
following syntax:
<pre>
java -jar <i>jarname.jar</i>
</pre>
The only requirement of the <i>jarname.jar</i> file is that it contains a manifest attribute
with the key <code>Main-Class</code>.  Suppose your application entry point is the class
<code>com.mydomain.mypackage.Main</code>.  You would add the following line to the <code>META-INF/MANIFEST.MF</code>
file:

<pre>
Main-Class: com.mydomain.mypackage.Main
</pre>

So far so good.  But, here's where the problems usually start.  Any non-trivial Java application 
is going to rely on any number of supporting Jar files.  For example, if you are using the Apache
Commons Logging capabilty to do logging your application will need to have the <code>commons-logging.jar</code>
file on its classpath.
<p>
Most developers reasonably assume that putting such a Jar file into their own Jar file, and adding a <code>Class-Path</code>
attribute to the <code>META-INF/MANIFEST</code> will do the trick:

<pre>
jarname.jar
| /META-INF
| | MANIFEST.MF
| |  Main-Class: com.mydomain.mypackage.Main
| |  Class-Path: commons-logging.jar
| /com/mydomain/mypackage
| | Main.class
| commons-logging.jar
</pre>
Unfortunately this is not the case.  The Java classloader does not know how to load classes from a Jar inside a Jar.
The entries on the <code>Class-Path</code> must be references to files outside the Jar file, defeating the goal of 
delivering an application in a single Jar file.

<h2>One-JAR: Cracking the Problem</h2>
One-Jar uses a classloader which knows how to load classes and resources from Jar files inside a Jar file.  To help provide some
structure to the classloading process, the One-Jar <code>JarClassLoader</code> looks for a main program inside
a <code>main</code> directory in the Jar file, and looks for supporting Jar files inside a <code>lib</code> directory.
Here is what our candidate Jar file would look like set up to run under One-Jar:

<pre>
jarname.jar
| /META-INF
| | MANIFEST.MF
| | | Main-Class: com.simontuffs.onejar.Boot
| | | One-Jar-Main-Class: com.mydomain.mypackage.Main
| /main
| | main.jar
| | | com.mydomain.mypackage.Main.class
| /lib
| | commons-logging.jar
| /com.simontuffs.onejar
| | Boot.class
| | etc.
| 
</pre>
That's pretty much all there is to it.  You wrap your main class in a file called <code>main.jar</code>, put it in an entry
called <code>main</code>, likewise you put your supporting Jar files under a directory called <code>lib</code>, 
change the top-level <code>Main-Class</code> to point to the bootstrap classloader from the One-Jar package, 
and then point to your main class with a new attributes <code>One-Jar-Main-Class</code>.   Don't worry, there's
an Ant task that will do this for you which I'll get to in a moment.  But first you may be interested in running
an application build with One-Jar <a href="http://prdownloads.sourceforge.net/one-jar/one-jar-example-0.96.jar?download">here</a>
Download this application and run it using <code>java -jar one-jar-example-0.96.jar</code>.  Then try it with 
verbose mode: <code>java -Done-jar.verbose=true -jar one-jar-example-0.96.jar</code> to get a detailed look at what's
going on in the classloader.

<p>This is roughly what you will see when you run the demo:
<pre>
$ java -jar one-jar-example-0.96.jar
Main: com.simontuffs.onejar.example.main.Main.main()
Test: loaded by com.simontuffs.onejar.DetectClassLoader@7a84e4
Test: codesource is jar:file:/C:/work/eclipse-workspaces/workspace-simontuffs/one-jar/dist/one-jar-example-0.96.jar!/main/main.jar
Test: java.class.path=one-jar-example-0.96.jar
Util: loaded by com.simontuffs.onejar.DetectClassLoader@7a84e4
Util.sayHello()
... etc.
</pre>

<p>To see what options are supported by One-Jar use the <i>--one-jar-help</i> command line option on a One-Jar file:
<pre>
$ java -jar one-jar-example-0.96.jar --one-jar-help
One-Jar uses the following command-line arguments
    --one-jar-help Shows this message, then exits.

One-Jar uses the following VM properties (-D<property>=<true|false>)
    one-jar.main-class Specifies the name of the class which should be executed (via public static void main(String[])
    one-jar.record     true:  Enables recording of the classes loaded by the application
    one-jar.jar-names  true:  Recorded classes are kept in directories corresponding to their jar names.
                       false: Recorded classes are flattened into a single directory.  Duplicates are ignored (first wins)
    one-jar.verbose    true:  Print verbose classloading information
    one-jar.info       true:  Print informative classloading information
</pre>

<p>To see what the <code>JarClassLoader</code> is behind the scenes, enable verbose output using the
one-jar.verbose system property:
<pre>
$ java -Done-jar.verbose=true -jar one-jar-example-0.96.jar
JarClassLoader: One-Jar-Expand=expand,doc,file.txt
JarClassLoader: Info: resource: one-jar-example-0.96.jar!META-INF/MANIFEST.MF
JarClassLoader: cached bytes for class OneJar.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.Boot.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.Handler$1.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.Handler.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.IProperties.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.JarClassLoader$1.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.JarClassLoader$ByteCode.class
JarClassLoader: cached bytes for class com.simontuffs.onejar.JarClassLoader.class
JarClassLoader: Info: resource: one-jar-example-0.96.jar!OneJar.java
JarClassLoader: Info: resource: one-jar-example-0.96.jar!boot-manifest-external.mf
... many more lines until the first line of output from the Main class.
</pre>
This diagnostic output can prove useful when trying to debug class-loading issues.

<h2>Getting Started</h2>
If you want to build your application using One-Jar, download the <a href="http://prdownloads.sourceforge.net/one-jar/one-jar-sdk-0.96.jar?download">One-Jar Software Developers Kit</a>.
The kit is a One-Jar executable, which contains all the pieces needed to assemble One-Jar applications (and can also re-assemble itself).  When you 
run it you should see the following output:
<pre>
$ java -jar one-jar-sdk-0.96.jar
Extracting SDK... done.  
To build the "Hello One-Jar" example: $ ant hello
To run the "Hello One-Jar" example:   $ java -jar hello.jar
To rebuild the SDK:                   $ ant sdk
</pre>
This extracts a development project (also an Eclipse JDT project) which contains a directory
tree suitable for building a One-Jar application.  
<p>Note: you will need to download an Ant distribution in order to be able to rebuild the <code>hello.jar</code>
or the <code>sdk</code>.  You can obtain the latest version of ant here:
<a href="http://ant.apache.org/bindownload.cgi">http://ant.apache.org/bindownload.cgi</a>.  Alternatively
you can run Ant from within an IDE such as Eclipse.  You will also need a Java Runtime JRE 1.4 or later.

<p><code>$ ant hello</code> builds a simple One-Jar Jar file containing a single Main class, and a single Hello
class.  The Main class is bundled into <i>main.jar</i>, the Hello class is bundled into <i>hello.jar</i>, 
and the requisite One-Jar jar-file is constructed.  Main invokes Hello(), which prints "Hello One-Jar".

<p>You can use this project as a starting point for your own development, by editing the <code>hello/build.xml</code> file.

<hr>
If you like <i>One-JAR</i> then you might want to check out some of the other Open-Source projects
developed by simontuffs.com:
<table align="center" cellpadding="20">
	<tr>
		<td><a href="http://soap-stone.sourceforge.net" target="_blank"><img
			src="http://soap-stone.sourceforge.net/soap-stone.jpg" border="0"
			alt="soap-stone at sourceforge.net"></a></td>
		<td><a href="http://xml-xig.sourceforge.net" target="_blank"><img
			src="http://xml-xig.sourceforge.net/xml-xig.jpg" border="0"
			alt="XML Instance Generator"></a></td>
		<td><a href="http://jar-plug.sourceforge.net" target="_blank"><img
			src="http://jar-plug.sourceforge.net/jar-plug.jpg" border="0"
			alt="Eclipse JAR Plugin"></a></td>
		<td><a href="http://yaccl.sourceforge.net" target="_blank"><img
			src="http://yaccl.sourceforge.net/yaccl.jpg" border="0"
			alt="Yet Another Compiler Compiler Language"></a></td>
	</tr>
</table>
</body>
</html>
