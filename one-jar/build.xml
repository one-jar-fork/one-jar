<?xml version="1.0"?>

<project name="one-jar" default="dist" basedir=".">
	<property name="src.dir" value="${basedir}/src" />
	<property name="ant.dir" value="${basedir}/ant" />
	<property name="example.dir" value="${basedir}/example" />
	<property name="build.dir" value="${basedir}/build" />
	<property name="class.dir" value="${build.dir}/classes" />
	<property name="dist.dir" value="${basedir}/dist" />
	<property name="jar.dir" value="${build.dir}/jars" />

	<!-- version number -->
	<property name="one-jar.version" value="0.96" />

	<!-- jar files -->
	<property name="boot.jar" value="${dist.dir}/one-jar-boot-${one-jar.version}.jar" />
	<property name="example.jar" value="${dist.dir}/one-jar-example-${one-jar.version}.jar" />
	<property name="example-ext.jar" value="${dist.dir}/one-jar-example-ext-${one-jar.version}.jar" />
	<property name="main.jar" value="${jar.dir}/main/main.jar" />
	<property name="util.jar" value="${jar.dir}/lib/util.jar" />
	<property name="external.jar" value="${jar.dir}/external.jar" />
	<property name="wraploader.jar" value="${jar.dir}/detect/wrap/wraploader.jar" />
	<property name="extloader.jar" value="${jar.dir}/external/wrap/wraploader.jar" />

	<target name="init">
		<tstamp />
	</target>

	<!-- Make the build directories -->
	<target name="mkdirs" depends="init">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${class.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${jar.dir}" />
		<mkdir dir="${jar.dir}/main" />
		<mkdir dir="${jar.dir}/lib" />
		<mkdir dir="${jar.dir}/detect/wrap" />
		<mkdir dir="${jar.dir}/external/wrap" />
	</target>

	<!-- compile the source -->
	<target name="compile" depends="mkdirs">
		<javac destdir="${class.dir}" debug="on" deprecation="off" optimize="off">
			<src path="${src.dir}" />
		</javac>
		<javac destdir="${class.dir}" debug="on" deprecation="off" optimize="off">
			<src path="${example.dir}" />
		</javac>
	</target>

	<!-- Make the jar files -->

	<target name="build.main.jar">
		<jar destfile="${main.jar}" manifest="${example.dir}/main/main-manifest.mf">
			<fileset dir="${class.dir}">
				<include name="**/example/main/**" />
				<include name="**/example/util/Duplicate*" />
			</fileset>
			<fileset dir="${example.dir}">
				<include name="**/example/main/**" />
				<include name="**/example/util/Duplicate*" />
			</fileset>
			<fileset dir="${example.dir}/main">
				<include name="main-manifest.mf" />
				<include name="duplicate.txt" />
				<include name="images/*" />
			</fileset>
		</jar>
	</target>

	<target name="build.util.jar">
		<jar destfile="${util.jar}" manifest="${example.dir}/util/util-manifest.mf">
			<fileset dir="${class.dir}">
				<include name="**/example/util/**" />
			</fileset>
			<fileset dir="${example.dir}">
				<include name="**/example/util/**" />
			</fileset>
			<fileset dir="${example.dir}/util">
				<include name="util-manifest.mf" />
				<include name="duplicate.txt" />
			</fileset>
		</jar>
	</target>

	<target name="build.external.jar">
		<jar destfile="${external.jar}">
			<fileset dir="${class.dir}">
				<include name="**/example/external/**" />
			</fileset>
			<fileset dir="${example.dir}">
				<include name="**/example/external/**" />
			</fileset>
		</jar>
	</target>

	<target name="build.wraploader.jar">
		<jar destfile="${wraploader.jar}" manifest="${src.dir}/detectloader.mf">
			<fileset dir="${class.dir}">
				<include name="**/Detect*" />
			</fileset>
			<fileset dir="${src.dir}">
				<include name="**/Detect*" />
			</fileset>
		</jar>
	</target>

	<target name="build.extloader.jar">
		<jar destfile="${extloader.jar}" manifest="${src.dir}/extloader.mf">
			<fileset dir="${class.dir}">
				<include name="**/External*" />
			</fileset>
			<fileset dir="${src.dir}">
				<include name="**/External*" />
			</fileset>
		</jar>
	</target>

	<target name="build.boot.jar">
		<delete file="${boot.jar}" />
		<jar destfile="${boot.jar}" manifest="${src.dir}/boot-manifest.mf">
			<fileset dir="${class.dir}">
				<include name="com/**" />
				<exclude name="**/example/**" />
				<exclude name="**/ant/**" />
			</fileset>
			<fileset dir="${src.dir}">
				<include name="boot-manifest.mf" />
				<include name="com/**" />
				<exclude name="**/example/**" />
				<exclude name="**/Detect*" />
			</fileset>
			<fileset dir="${basedir}">
				<include name="doc/*license.txt" />
			</fileset>
		</jar>
	</target>

	<target name="build.ant.jar">
		<copy file="${boot.jar}" tofile="${class.dir}/com/simontuffs/onejar/ant/one-jar-boot.jar" />
		<jar destfile="${dist.dir}/one-jar-ant-${one-jar.version}.jar">
			<fileset dir="${class.dir}">
				<include name="**/ant/**" />
			</fileset>
			<fileset dir="${ant.dir}">
				<include name="**/ant/**" />
			</fileset>
		</jar>
		<copy todir="${dist.dir}">
			<fileset dir="${ant.dir}">
				<include name="one-jar-*.xml" />
			</fileset>
		</copy>

	</target>

	<target name="build.example.jar" depends="build.main.jar,build.util.jar">
		<delete file="${example.jar}"/>
		<jar destfile="${example.jar}" manifest="${src.dir}/boot-manifest.mf">
			<fileset dir="${class.dir}">
				<exclude name="**/Detect*" />
				<exclude name="**/External*" />
				<exclude name="**/example/**" />
				<exclude name="**/main/**" />
				<exclude name="**/util/**" />
				<exclude name="**/ant/**" />
			</fileset>
			<fileset dir="${src.dir}">
				<include name="com/**" />
				<exclude name="**/example/**" />
				<exclude name="**/Detect*" />
				<exclude name="**/External*" />
			</fileset>
			<fileset dir="${basedir}">
				<include name="doc/*license.txt" />
			</fileset>
			<fileset dir="${jar.dir}">
				<include name="main/main.jar" />
				<include name="lib/util.jar" />
			</fileset>
			<fileset dir="${jar.dir}/detect">
				<include name="wrap/wraploader.jar" />
			</fileset>
		</jar>
	</target>

	<target name="build.example-ext.jar">
		<jar destfile="${example-ext.jar}" manifest="${src.dir}/boot-manifest.mf">
			<fileset dir="${class.dir}">
				<exclude name="**/Detect*" />
				<exclude name="**/External*" />
				<exclude name="**/example/**" />
			</fileset>
			<fileset dir="${src.dir}">
				<include name="com/**" />
				<exclude name="**/example/**" />
				<exclude name="**/Detect*" />
				<exclude name="**/External*" />
			</fileset>
			<fileset dir="${basedir}">
				<include name="doc/*license.txt" />
			</fileset>
			<fileset dir="${jar.dir}">
				<include name="main/main.jar" />
				<include name="lib/util.jar" />
			</fileset>
			<fileset dir="${jar.dir}/external">
				<include name="wrap/wraploader.jar" />
			</fileset>
		</jar>
	</target>

	<target name="jar" depends="build.main.jar,build.util.jar,build.boot.jar,build.ant.jar,build.external.jar,build.wraploader.jar,build.extloader.jar,build.example.jar,build.example-ext.jar">
	</target>

	<!-- Build the example jar using the one-jar-macro -->
	<import file="${dist.dir}/one-jar-macro.xml" optional="true" />
	<target name="one-jar-example-macro" depends="jar">
		<delete file="${dist.dir}/one-jar-example-${one-jar.version}-macro.jar" />
		<one-jar-macro destfile="${dist.dir}/one-jar-example-${one-jar.version}-macro.jar" manifest="${src.dir}/boot-manifest.mf" mainmanifest="${example.dir}/main/main-manifest.mf" onejarboot="${boot.jar}">
			<main>
				<fileset dir="${class.dir}">
					<include name="**/example/main/**" />
					<include name="**/example/util/Duplicate*" />
				</fileset>
				<fileset dir="${example.dir}">
					<include name="**/example/main/**" />
					<include name="**/example/util/Duplicate*" />
				</fileset>
				<fileset dir="${example.dir}/main">
					<include name="main-manifest.mf" />
					<include name="duplicate.txt" />
				</fileset>
			</main>
			<lib>
				<fileset file="${jar.dir}/lib/**" />
			</lib>
		</one-jar-macro>
	</target>

	<!-- Build the example jar using the one-jar task.  Identical syntax to the 
	     one-jar-macro, but creates the target jar without using the filesystem
	     for intermediates.
	-->
	<import file="${dist.dir}/one-jar-task.xml" optional="true" />
	<target name="one-jar-example-task" depends="build.ant.jar">
		<delete file="dist/one-jar-example-${one-jar.version}-task.jar" />
		<one-jar destfile="dist/one-jar-example-${one-jar.version}-task.jar" manifest="${src.dir}/boot-manifest.mf">
			<main manifest="${example.dir}/main/main-manifest.mf">
				<fileset dir="${class.dir}">
					<include name="**/example/main/**" />
					<include name="**/example/util/Duplicate*" />
				</fileset>
				<fileset dir="${example.dir}">
					<include name="**/example/main/**" />
					<include name="**/example/util/Duplicate*" />
				</fileset>
				<fileset dir="${example.dir}/main">
					<include name="main-manifest.mf" />
					<include name="duplicate.txt" />
				</fileset>
			</main>
			<lib>
				<fileset file="${jar.dir}/lib/**" />
			</lib>
		</one-jar>
	</target>


	<!-- Make the distribution -->
	<target name="dist" depends="compile,jar">
		<copy file="${ant.dir}/one-jar-macro.xml" todir="${dist.dir}" />
		<copy file="${ant.dir}/one-jar-task.xml" todir="${dist.dir}" />
	</target>

	<!-- Test the distribution -->
	<target name="test" depends="dist">
		<junit fork="yes" showoutput="yes" printsummary="yes">
			<jvmarg value="-Done-jar.verbose=true" />
			<jvmarg value="-Done-jar.jarname=${basedir}/dist/one-jar-example-${one-jar.version}.jar" />
			<classpath>
				<fileset file="${basedir}/dist/one-jar-example-${one-jar.version}.jar" />
				<path location="${basedir}/bin/test" />
			</classpath>

			<test name="com.simontuffs.onejar.test.SelfTest" />
			<formatter type="plain" usefile="no" />
		</junit>
	</target>

	<target name="clean" depends="init">
		<!-- delete everything in the classes dir -->
		<delete dir="${build.dir}" />
	</target>

</project>